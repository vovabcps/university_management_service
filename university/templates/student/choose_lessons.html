{% extends "student/base_s.html" %}
{% load i18n static %}
{% load university_mytags %}


{% block extrahead %}
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
{% endblock %}


{% block title %}Turmas{% endblock %}

{% block content_title %}Preencha o formulario:{% endblock %}

{% block breadcrumbs %}
        › Inscrição Turmas
{% endblock %}


{% block content %}
<div id="content-main">


		<div class="row">
			<div class="col-lg-12">
				<div class="panel panel-default">
					<div class="panel-heading">Incrições em turmas</div>
					<div class="panel-body">
						<div class="col-md-12">
             
                <form role="form" id="insert_disciplina" method="post" onsubmit="return false">

                 <!-- {{ subjsSem }}  -->


                {% for semestre, subjs in subjsSem.items %}
                <button type="button" onclick="chooseSem('{{semestre}}sem')">{{semestre}} semestre</button>

                <div id="{{semestre}}sem">
                  {% for subj, dicTypeTurmaLessons in subjs.items %}
                    <p>{{subj.name}}</p>
                    {% for tipo, turmasLessons in dicTypeTurmaLessons.items %}
                    <p>{{tipo}}</p>
                    <div id="{{semestre}}sem|{{subj.name}}|{{tipo}}">
                    {% for turmaLessons in turmasLessons %}

                    
                    <button type="button" data-lessons="{{turmaLessons|last}}" onclick="marcado(this,'{{semestre}}sem|{{subj.name}}|{{tipo}}');criarHorario('{{semestre}}sem')" value="{{subj.name}}|{{turmaLessons|first}}|{{tipo}}" >{{turmaLessons|first}}</button>

                    {% endfor %}
                  </div>

                    {% endfor %}
                    <br><br><br><br>
                  {% endfor %}
                </div>

                {% endfor %}

                <br><br>
                
                <button id="submit" type="submit" style="float: right" class="btn btn-lg btn-primary" >Confirmar e Finalizar</button>
                <button type="button" class="btn btn-default"><a href="{% url 'inscricoes_subject_s' %}">Voltar</a></button>
							</form>
						</div>
					</div>
        </div><!-- /.panel-->

			</div><!-- /.col-->
    </div><!-- /.row -->
    
    <table id="tabelaSchedule"></table> 
</div>

<script>

  function chooseSem(sem){
    if (sem == "1sem"){
      document.getElementById("1sem").style.display = "block";
      document.getElementById("2sem").style.display = "none";
    }else{
      document.getElementById("2sem").style.display = "block";
      document.getElementById("1sem").style.display = "none";
    }
    criarHorario(sem)
    
  }

  chooseSem("1sem");

  function criarHorario(semestre){
    document.getElementById("tabelaSchedule").innerHTML= "";
    //reset pq os valores do dic tem q estar ordenados

    //todas os botoes das turmas q foram "activados" num semestre
    allTurmasEscolhidas= document.querySelectorAll("button[data-"+ semestre +"=true]");

    
    var lstLessons= []
    for (var i = 0; i < allTurmasEscolhidas.length; i++) {
      turma= allTurmasEscolhidas[i].getAttribute("data-lessons")
      turmaLessons= turma.split("|").slice(0, -1);
      lstLessons= lstLessons.concat(turmaLessons)
    }

     //percorrer a lista com todas as lessons
     var lstlesson= []
     for (var i = 0; i < lstLessons.length; i++) {
       lesson= lstLessons[i].split(",")
       lesson[3]=  getSigla(lesson[3])
      lstlesson.push(lesson)
    }
   
    var scheduleDict= {}

    for (var i = 0; i<lstlesson.length; i++){
      if (lstlesson[i][0] in scheduleDict) {
        scheduleDict[lstlesson[i][0]].push(lstlesson[i].slice(1, 6))
      }else{
        scheduleDict[lstlesson[i][0]]= [lstlesson[i].slice(1, 6)]
      }
    }


    // Importante: para o mesmo dia de semana, as aulas TEM QUE ESTAR POR ORDEM!! (by time) 
    for (var key in scheduleDict) {
      scheduleDict[key]= scheduleDict[key].sort(function(a,b){return (a[0] > b[0]) ? 1 : -1});
    }
    console.log(scheduleDict)

    buildSchedule(scheduleDict);
   
  }


  function getSigla (umaString){
    lista = umaString.split(" ")
    sigla = ""
    for (var i = 0; i<lista.length; i++){
      if (lista[i].length > 3) {
        sigla = sigla + lista[i][0]
      }
    }
    return sigla
  }



  $(document).ready(function () {
    $('#submit').click(function(evt) {
      evt.preventDefault(); 
      var r = confirm('Depois de confirmar nao podera voltar atras!');
      if (r) {   
        login()               
      }  
    });  
  });

  function login() {
    allTurmasEscolhidas1sem= document.querySelectorAll("button[data-1sem=true]");
    allTurmasEscolhidas2sem= document.querySelectorAll("button[data-2sem=true]");

    txt1sem= "";
    for(var i=0; i<allTurmasEscolhidas1sem.length; i++){
      txt1sem = txt1sem + allTurmasEscolhidas1sem[i].value + "||";
    }

    txt2sem= "";
    for(var i=0; i<allTurmasEscolhidas2sem.length; i++){
      txt2sem = txt2sem + allTurmasEscolhidas2sem[i].value + "||";
    }


    $.ajax({
        type: "POST",
        url: 'inscricoes_confirmacao',
        data: JSON.stringify({'1semLessons': txt1sem, '2semLessons': txt2sem}),
        success: function (data) {
          if (data['message'] == "success") {
              alert("Foi inscrito com sucesso")
              window.location.href = "home";
          } else if (data['message'] == "inactive") {
          } else {
              alert("Ocorreu um problema na sua inscriçao, volte a tentar.")
          }
      }
    });

    
}

</script>


{% endblock %}
	