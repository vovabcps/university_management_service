{% extends "student/base_s.html" %}
{% load i18n static %}
{% load university_mytags %}


{% block extrahead %}
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
{% endblock %}


{% block title %}Turmas{% endblock %}

{% block content_title %}{% endblock %}

{% block breadcrumbs %}
› Inscrição Turmas
{% endblock %}


{% block content %}
<div id="content-main">

  <style>
    .tab-content {
      padding: 0;
    }
    .box_semestres_bar{
      border-bottom:1px solid #e9ecf2;
      margin-bottom: 2px;
      padding: 2px 0px 2px 1px;
    border-top-left-radius: 3px;
    border-top-right-radius: 3px;
    }

    .semestres ul {
      padding: 5px;
    }

    .semestres > .nav-pills li.active a{
      background-color : dimgrey !important;
  }

  #myProgress {
    width: 100%;
    background-color: #ddd;
    border-bottom-left-radius: 5px;
    border-bottom-right-radius: 5px;
    border-top-left-radius: 5px;
    border-top-right-radius: 5px;
  }
  
  #myBar {
    width: 0%;
    height: 20px;
    background-color: rgba(68, 192, 250, 0.596);
    text-align: center;
    line-height: 20px;
    color: black;
  }
  
  #percent{
    padding-left: 4px;
  }

  .prog_bar{
    width: 80%;
    margin: 5px auto;
  }
  </style>

  <br>
  <div class="row">
    <div class="col-lg-12">
      <div class="panel panel-default">

        <!-- {{ subjsSem }}  -->

        <form role="form" id="insert_disciplina" method="post" onsubmit="return false">


        
      <div class="w3-row box_semestres_bar">
          <div class=" w3-third">
              <div class="semestres">
                  <ul class="nav nav-pills" role="tablist">
                      <li class="nav-item active">
                        <a class="nav-link active" data-toggle="pill" href="#semestre1" onclick="criarHorario('1sem')">1º Semestre</a>
                      </li>
                      <li class="nav-item">
                        <a class="nav-link" data-toggle="pill" href="#semestre2" onclick="criarHorario('2sem')" >2º Semestre</a>
                      </li>
                    </ul>
              </div>
          </div>

          <div class="w3-twothird">
            <div class="prog_bar">
              <div id="myProgress">
                  <div id="myBar"><span id="percent">0</span>%</div>
                </div>
              </div>
          </div>

      </div> <!-- end row-->
          

        <div class="panel-body">

        
          <div class="w3-row">
              <div class=" w3-third">

          <div class="tab-content">
            {% for semestre, subjs in subjsSem.items %}

            {% if semestre == "1" %}
            <div id="semestre1" class=" tab-pane active">

              {% else %}
              <div id="semestre2" class=" tab-pane fade">
                {% endif %}

                <!-- em comum -->
                <ul class="nav nav-pills" role="tablist">

                  {% for subj, dicTypeTurmaLessons in subjs.items %}

                  {% if forloop.counter == 1 %}
                  <li class="nav-item active ">
                    <a class="nav-link active" data-toggle="pill"
                      href="#{{semestre}}sem{{subj.getSigla}}">{{subj.name}}</a>
                  </li>
                  {% else %}
                  <li class="nav-item">
                    <a class="nav-link " data-toggle="pill" href="#{{semestre}}sem{{subj.getSigla}}">{{subj.name}}</a>
                  </li>
                  {% endif %}

                  {% endfor %}
                </ul>

                    <div class="tab-content">
                       
                      {% for subj, dicTypeTurmaLessons in subjs.items %}

                      {% if forloop.counter == 1 %}
                      <div id="{{semestre}}sem{{subj.getSigla}}" class=" tab-pane active">
                        {% else %}
                        <div id="{{semestre}}sem{{subj.getSigla}}" class=" tab-pane fade">
                          {% endif %}

                          {% for tipo, turmasLessons in dicTypeTurmaLessons.items %}
                          <br>
                          {% if tipo == "T" %}
                            <p>TEORICAS</p>
                          {% elif  tipo == "TP" %}
                            <p>PRATICAS</p>
                          {% elif  tipo == "PL" %}
                            <p>LABORATORIAIS</p>
                          {% elif  tipo == "O" %}
                            <p>OUTRA</p>
                          {% elif  tipo == "S" %}
                            <p>SINPOSIO</p>
                          {% else %}
                            <p>{{tipo}}</p>
                          {% endif %}
                      
                          <div class="turmas" id="{{semestre}}sem|{{subj.name}}|{{tipo}}">
                            {% for turmaLessons in turmasLessons %}


                            <button type="button" class="w3-button-small w3-khaki w3-round"
                              data-lessons="{{turmaLessons|last}}"
                              onclick="marcado(this,'{{semestre}}sem|{{subj.name}}|{{tipo}}');criarHorario('{{semestre}}sem');move()"
                              value="{{subj.name}}|{{turmaLessons|first}}|{{tipo}}">{{tipo}}{{turmaLessons|first}}
                            </button>

                            {% endfor %}
                          </div>

                          {% endfor %}
                        </div>

                        {% endfor %}
                      </div> <!-- class="tab-content" -->
                   
                </div>
                {% endfor %}
              </div> <!-- class="tab-content" -->

              </div>
              
              <div class="w3-twothird">
                  <table id="tabelaSchedule"></table>
                </div>
            
            </div> <!-- end row -->

          </div>
       

              <br>
              <br>

              <button id="submit" type="submit" style="float: right" class="btn btn-lg btn-primary">Confirmar e
                Finalizar</button>
              <button type="button" class="btn btn-default"><a
                  href="{% url 'inscricoes_subject_s' %}">Voltar</a></button>
                  <br>
                  <br>
        </form>

      </div><!-- /.panel-->
    </div><!-- /.col-->
  </div><!-- /.row -->



</div>

<script>
  document.getElementById("content_titleRow").style.display = "none";
  criarHorario("1sem")
  function criarHorario(semestre) {
    console.log(semestre)
    //reset pq os valores do dic tem q estar ordenados
    document.getElementById("tabelaSchedule").innerHTML= "";

    //todas os botoes das turmas q foram "activados" num semestre
    allTurmasEscolhidas = document.querySelectorAll("button[data-" + semestre + "=true]");


    var lstLessons = []
    for (var i = 0; i < allTurmasEscolhidas.length; i++) {
      turma = allTurmasEscolhidas[i].getAttribute("data-lessons")
      turmaLessons = turma.split("|").slice(0, -1);
      lstLessons = lstLessons.concat(turmaLessons)
    }

    //percorrer a lista com todas as lessons
    var lstlesson = []
    for (var i = 0; i < lstLessons.length; i++) {
      lesson = lstLessons[i].split(",")
      lesson[1] = format(lesson[1])
      lesson[3] = getSigla(lesson[3])
      lstlesson.push(lesson)
    }

    var scheduleDict = {}

    for (var i = 0; i < lstlesson.length; i++) {
      if (lstlesson[i][0] in scheduleDict) {
        scheduleDict[lstlesson[i][0]].push(lstlesson[i].slice(1, 6))
      } else {
        scheduleDict[lstlesson[i][0]] = [lstlesson[i].slice(1, 6)]
      }
    }
    console.log(scheduleDict)

    // Importante: para o mesmo dia de semana, as aulas TEM QUE ESTAR POR ORDEM!! (by time) 
    for (var key in scheduleDict) {
      scheduleDict[key] = scheduleDict[key].sort(function (a, b) {
        return maior(a[0], b[0])
      });
    }
    console.log(scheduleDict)

    buildSchedule(scheduleDict);

  }

  function maior(str1, str2){
    console.log(str1 + " " + str2)
    var res;
    if ((str1.length + str2.length) == 9 ){
    //"10:00" > "9:30"
    console.log(! (str1 > str2))
    res= (! (str1 > str2))
    }
    else{
      res= str1 > str2
    }

    if (res){
      return 1
    }else{
      return -1
    }
  }

  function format(hour) {
    //ex: 08:00 -> 8:00
    if (hour[0] == "0") {
      hour = hour.substring(1)
    }
    return hour
  }


  function getSigla(umaString) {
    lista = umaString.split(" ")
    sigla = ""
    for (var i = 0; i < lista.length; i++) {
      if (lista[i].length > 3 && lista[i].indexOf('(') <= -1) {
        sigla = sigla + lista[i][0]
      }
      if (lista[i].indexOf('I') > -1 && lista[i].indexOf('(') <= -1) { //(LTI) / PII
                sigla = sigla + lista[i]
      }
    }
    return sigla
  }



  $(document).ready(function () {
    $('#submit').click(function (evt) {
      evt.preventDefault();
      var r = confirm('Depois de confirmar nao podera voltar atras!');
      if (r) {
        login()
      }
    });
  });

  function move() {
    var totalAllLessons = document.getElementsByClassName("turmas").length;
    var allTurmasEscolhidas1sem = document.querySelectorAll("button[data-1sem=true]").length;
    var allTurmasEscolhidas2sem = document.querySelectorAll("button[data-2sem=true]").length;

    var escolhidos= allTurmasEscolhidas1sem + allTurmasEscolhidas2sem
    var aumento= 100/totalAllLessons;
    console.log(totalAllLessons)
    console.log(escolhidos)

    var elem = document.getElementById("myBar");   
    var prog = document.getElementById("percent");
    var width= prog.innerHTML; 

    width = escolhidos * aumento; 
    elem.style.width = width + '%'; 
    prog.innerHTML = width;
    if (width >= 100) {
      elem.style.backgroundColor= "green";
      elem.style.color= "white";
      elem.innerHTML= "Finalize a inscriçao! ";
    }

  }

  function login() {
    totalAllLessons = document.getElementsByClassName("turmas").length
    allTurmasEscolhidas1sem = document.querySelectorAll("button[data-1sem=true]");
    allTurmasEscolhidas2sem = document.querySelectorAll("button[data-2sem=true]");

    txt1sem = "";
    for (var i = 0; i < allTurmasEscolhidas1sem.length; i++) {
      txt1sem = txt1sem + allTurmasEscolhidas1sem[i].value + "||";
    }

    txt2sem = "";
    for (var i = 0; i < allTurmasEscolhidas2sem.length; i++) {
      txt2sem = txt2sem + allTurmasEscolhidas2sem[i].value + "||";
    }


    $.ajax({
      type: "POST",
      url: 'inscricoes_confirmacao',
      data: JSON.stringify({
        '1semLessons': txt1sem,
        '2semLessons': txt2sem,
        'totalLessons' : totalAllLessons
      }),
      success: function (data) {
        if (data['message'] == "success") {
          alert("Foi inscrito com sucesso")
          window.location.href = "home";
        } else if (data['message'] == "inactive") {} else {
          alert("Ocorreu um problema na sua inscriçao, volte a tentar.")
        }
      }
    });
  }

</script>


{% endblock %}