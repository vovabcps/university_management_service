{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block title %}Export{% endblock %}

{% block content_title %}Exportar Dados{% endblock %}

{% block extrastyle %}{{ block.super }}
    <link rel="stylesheet" type="text/css" href="{% static "admin/css/dashboard.css" %}">{% endblock %}
{% block bodyclass %}{{ block.super }} dashboard{% endblock %}

{% block breadcrumbs %}
    <div class="breadcrumbs">
        <a href="{% url 'home_a' %}"><em class="fas fa-file-export"></em></a> â€º Export
    </div>
{% endblock %}

{% block content %}


    <body>

    <div class="container">
        <div id="action_area">
            <img id="export_loading_img" style="display: none" src="{% static "our/img/loading2.gif" %}" alt="">
            <button class="button" id="export_database">Export database json file</button>
            {% csrf_token %}
        </div>
    </div>

    {% comment %}
  <div class="container">
      <p>Lista de Tabelas</p>
      <form method=POST action="">
          {{ app_list }}
      </form>

      <table>
          {% for item in query_results %}
          <tr>
              <td></td>
          </tr>
          {% endfor %}
      </table>
  </div>





  <form id= "tabelasExport" method="post" action="" enctype="multipart/form-data">
    <h5>Tabelas</h5>
<select name="Tabelas">
      <option value="Faculdade">Faculdade</option>
      <option value="Curso">Curso</option>
      <option value="SchoolYear">SchoolYear</option>
      <option value="Room">Room</option>
      <option value="Role">Role</option>
      <option value="SystemUser">SystemUser</option>
      <option value="PersonalInfo">PersonalInfo</option>
      <option value="SystemUser_Faculdade">SystemUser_Faculdade</option>
      <option value="Course_Faculdade">Course_Faculdade</option>
      <option value="Course_SchoolYear">Course_SchoolYear</option>
      <option value="SystemUserCourse">SystemUserCourse</option>
      <option value="SystemUser_SchoolYear">SystemUser_SchoolYear</option>
      <option value="Subject">Subject</option>
    </select>   
 <br><br>
    <input type="submit">
  </form>
  {% endcomment %}
    <script>

        $(document).ready(function () {

            $('#export_database').on('click ', function () {
                $("#export_database").toggle();
                $("#export_loading_img").toggle();

                let csrf = $("[name=csrfmiddlewaretoken]").val();
                $.ajax({
                    beforeSend: function(xhr, settings) {
                      xhr.setRequestHeader("X-CSRFToken", csrf)
                    },
                    url: "{% url 'export_db_api' %}",
                    type: "POST",
                    //dataType: 'json',
                    success: function (res) {
                        let a = document.createElement('a');
                        a.href = window.URL.createObjectURL(new Blob([JSON.stringify(res)], {type: 'application/json'}));
                        a.download = 'db.json';
                        a.click();
                        window.URL.revokeObjectURL(a.href);
                    },
                    error: function (err) {
                        alert(err)
                    }
                }).done(function () {
                    $("#export_database").toggle();
                    $("#export_loading_img").toggle();
                });
            });
        });


    </script>
    </body>

{% endblock %}
